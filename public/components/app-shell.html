<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="app-router.html">
<link rel="import" href="app-state.html">
<link rel="import" href="app-pages.html">

<dom-module id="app-shell">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-state state="{{state}}"></app-state>
    <app-router default-url="home"></app-router>

    <a href="/home">home</a>
    <app-pages page="[[state.session.route.segments.0]]">
      <home-page page="home"
                 user="[[state.persistent.user]]"
                 projects="[[state.persistent.projects]]">
      </home-page>
      <editor-page page="editor"
                   user-name="[[state.persistent.user.name]]"
                   project-id="[[state.persistent.user.currentProject]]"
                   version="[[state.persistent.user.currentVersion]]"
                   versions="[[_currentVersions]]"
                   files="[[_currentFiles]]">
      </editor-page>
      <notfound-page page="notfound"></notfound-page>
    </app-pages>

  </template>
  <script>
    class AppShell extends IntertextMixin(Polymer.Element) {
      static get is() {
        return 'app-shell';
      }

      static get properties() {
        return {
          state: Object,
          _currentVersions: {
            type: Array,
            computed: "_retrieveVersions(state.persistent.user.currentProject)"
          },
          _currentFiles: {
            type: Array,
            computed: "_retrieveFiles(state.persistent.user.currentProject, state.persistent.user.currentVersion)"
          }
        }
      }

      _retrieveVersions(projectID) {
        if (projectID && this.state.persistent.projects[projectID].versions)
          return Object.keys(this.state.persistent.projects[projectID].versions);
      }

      _retrieveFiles(projectID, versionNumber) {
        if (!projectID || !versionNumber)
          return;
        const project = this.state.persistent.projects[projectID];
        const version = project.versions[versionNumber];
        const res = [];
        for (let file in version.files)
          res.push(version.files[file]);
        return res;
      }
    }

    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>