<dom-module id="code-preview">
  <template>
    <style>
       :host {
        display: block;
      }
    </style>

  </template>
  <script>
    class CodePreview extends Polymer.Element {
      static get is() {
        return 'code-preview';
      }

      static get properties() {
        return {
          files: {
            type: Object,
            value: () => ({})
          },
          preview: {
            type: String
          },
          path: {
            type: String
          },
          TYPES: {
            type: Object,
            value: () => ({
              html: 'text/html',
              css: 'text/css',
              js: 'application/javascript',
              json: 'application/json'
            })
          }
        }
      }

      open() {
        this.preview = this._makePreview('index.html');
        window.open(this.preview, 'Preview', "noopener,menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes");  //todo open in new tab, in background / no focus
      }

      update() {
        this.preview = this._makePreview('index.html');
        localStorage.setItem(this.path, this.preview);
      }

      _makePreview(entry) {
        let index = this.files[entry].value;
        let indexDoc = CodePreview.parseHTML(index);
        const deps = this._findDeps(indexDoc, entry);
        indexDoc = this._computeLinks(indexDoc, deps);
        indexDoc = this._addScript(indexDoc);
        index = indexDoc.documentElement.innerHTML;
        return CodePreview.makeURL(index, 'text/html');
      }

      _addScript(doc) {
        let s = document.createElement("script");
        s.innerHTML = `
        window.addEventListener('storage',function(e) {
          if (e.key !== '${this.path}')
            return;
          window.history.pushState({}, null, e.newValue);
          window.location.reload();
        });`;
        doc.head.appendChild(s);
        return doc;
      }

      _findDeps(doc, entry) {
        let res = {};
        for (let key in this.files) {
          if (key === entry)
            continue;
          let file = this.files[key];
          const ext = file.name.split('.').pop();
          let query = CodePreview.makeQuery(file.name, ext);
          let node = doc.querySelector(query);
          res[key] = {
            name: key,
            type: this.TYPES[ext],
            node: node,
            value: this.files[key].value
          }
        }
        return res;
      }

      _computeLinks(doc, deps) {
        for (let key in deps) {
          let dep = deps[key];
          if (!dep.node)
            continue;
          let value = CodePreview.addSourceURL(dep.value, dep.name, dep.type);
          let url = CodePreview.makeURL(value, dep.type);
          let attr = dep.type.startsWith('text/') ? 'href' : 'src';
          dep.node.setAttribute(attr, url);
        }
        return doc;
      }

      static parseHTML(str) {
        const parser = new DOMParser();
        return parser.parseFromString(str, 'text/html');
      }

      static makeQuery(name, ext) {
        if (ext === 'html' || ext === 'css')
          return `link[href="${name}"]`;
        else if (ext === 'js' || ext === 'json')
          return `script[src="${name}"]`;
      }

      static addSourceURL(str, name, type) {
        switch (type) {
          case 'text/css':
            return str + ` /*# sourceURL=${name} */`;
          case 'application/javascript':
            return str + ` //# sourceURL=${name}`;
          default:
            return str;
        }
      }

      static makeURL(str, type) {
        const blob = new Blob([str], {
          type: type
        });
        return URL.createObjectURL(blob);
      }
    }
    customElements.define(CodePreview.is, CodePreview);
  </script>
</dom-module>