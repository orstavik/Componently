<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="app-router.html">
<link rel="import" href="app-state.html">
<link rel="import" href="app-pages.html">

<dom-module id="app-shell">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-state state="{{state}}"></app-state>
    <app-router default-url="home"></app-router>

    <a href="/home">home</a>
    <app-pages page="[[state.session.route.segments.0]]">
      <home-page page="home"
                 user="[[state.persistent.user]]"
                 projects="[[_userProjects]]">
      </home-page>
      <editor-page page="editor"
                   current-project="[[state.persistent.currentProject]]"
                   versions="[[_currentVersions]]"
                   files="[[_currentFiles]]">
      </editor-page>
      <notfound-page page="notfound"></notfound-page>
    </app-pages>

  </template>
  <script>
    class AppShell extends IntertextMixin(Polymer.Element) {
      static get is() {
        return 'app-shell';
      }

      static get properties() {
        return {
          state: Object,
          _currentVersions: {
            type: Array,
            computed: "_retrieveVersions(state.persistent.currentProject, state.persistent.users)"
          },
          _currentFiles: {
            type: Object,
            computed: "_retrieveFiles(state.persistent.currentProject, state.persistent.users)"
          },
          _userProjects: {
            type: Array,
            computed: "_retrieveUserProjects(state.persistent.user.name, state.persistent.users)"
          }
        }
      }

      _retrieveVersions(currentProject, users) {
        if (!currentProject || !users)
          return [];
        let owner = currentProject.owner;
        let project = currentProject.project;
        let version = currentProject.version;
        if (!Tools.testPath(users, [owner, "projects", project, "versions"]))
          return [];
        return Object.keys(users[owner].projects[project].versions);
      }

      _retrieveFiles(currentProject, users) {
        if (!currentProject || !users)
          return [];
        let owner = currentProject.owner;
        let project = currentProject.project;
        let version = currentProject.version;
        if (!Tools.testPath(users, [owner, "projects", project, "versions", version, "files"]))
          return [];
        const files = users[owner].projects[project].versions[version].files;
        return files;
      }

      _retrieveUserProjects(username, users) {
        if (!username || !users)
          return [];
        return users[username].projects;
      }
    }

    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>