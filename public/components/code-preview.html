<dom-module id="code-preview">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    

  </template>
  <script>
    class CodePreview extends Polymer.Element {
      static get is() {
        return 'code-preview';
      }

      static get properties() {
        return {
          files: {
            type: Object,
            value: () => ({})
          },
          preview: {
            type: Object
          },
          dependencies: {
            type: Object,
            value: () => ({})
          },
          NODETYPES: {
            type: Object,
            value: () => ({
              html: 'div',
              css: 'style',
              js: 'script',
              json: 'script'
            })
          }
        }
      }
      
      open() {
        this.preview = window.open('', 'Preview', 'width=600,height=600');
        this.preview.document.title = 'Preview';
        this.bundle();
      }

      update() {
        if (!this.preview)
          return;
        for (let filename in this.dependencies) {
          let dep = this.dependencies[filename];
          let updateMethod = dep.node.tagName === 'DIV' ? 'innerHTML' : 'textContent';
          dep.node[updateMethod] = this.files[filename].value;
        }
      }

      bundle() {
        const head = this.preview.document.querySelector('head');
        const body = this.preview.document.querySelector('body');
        this._bundleFiles('html');
        this._bundleFiles('css');
        this._bundleFiles('js');
        this._bundleFiles('json');
      }

      _bundleFiles(type) {
        const head = this.preview.document.querySelector('head');
        const body = this.preview.document.querySelector('body');
        const writeMethod = (type === 'html') ? 'innerHTML' : 'textContent';
        const nodeType = this.NODETYPES[type];
        const files = CodePreview.filterType(this.files, type);
        for (let file of files) {
          let tag = document.createElement(nodeType);
          tag.id = file.name;
          if (type === 'json')
            scriptTag.type = 'application/json';
          tag[writeMethod] = file.value;
          (type === 'html') ? body.appendChild(tag) : head.appendChild(tag)
          this.dependencies[file.name] = {
            node: tag
          }
        }
      }

      static filterType(obj, type) {
        let res = [];
        for (let key in obj) {
          if (obj[key].name.endsWith(type))
            res.push(obj[key])
        }
        return res;
      }
    }
    customElements.define(CodePreview.is, CodePreview);
  </script>
</dom-module>