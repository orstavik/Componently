<link rel="import" href="../libs/codemirror.html">
<link rel="import" href="../libs/material.html">
<!--<script src="../bower_components/codemirror/lib/codemirror.js"></script>-->
<!--<script src="../bower_components/codemirror/mode/css/css.js"></script>-->
<!--<script src="../bower_components/codemirror/mode/css/css.js"></script>-->
 <!--<script src="../bower_components/codemirror/mode/xml/xml.js"></script>-->
<!--&lt;!&ndash;<script src="../bower_components/codemirror/mode/htmlmixed/htmlmixed.js"></script>&ndash;&gt;-->
<!--<script src="../bower_components/codemirror/mode/javascript/javascript.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/edit/closetag.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/edit/closebrackets.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/dialog/dialog.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/search/searchcursor.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/search/search.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/search/matchesonscrollbar.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/search/jump-to-line.js"></script>-->
<!--<script src="../bower_components/codemirror/addon/scroll/annotatescrollbar.js"></script>-->

<dom-module id="code-editor">
  <template>
    <style include="codemirror material">
      :host {
        display: inline-flex;
        flex-direction: column;
        box-sizing: border-box;
      }
      #title {
        position: relative;
        padding: 4px;
        text-align: center;
        background: black;
        color: lightgray;
      }
      #remove {
        position: absolute;
        font-weight: bold;
        font-family: Arial;
        color: red;
        right: 6px;
        cursor: pointer;
      }
      .CodeMirror {
        flex: 1;
      }
      .CodeMirror-vscrollbar::-webkit-scrollbar-track
      {
        -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
        border-radius: 4px;
        background-color: transparent;
      }
      
      .CodeMirror-vscrollbar::-webkit-scrollbar
      {
        width: 8px;
        background-color: transparent;
      }
      
      .CodeMirror-vscrollbar::-webkit-scrollbar-thumb
      {
        border-radius: 10px;
        background-color: rgba(255,255,255,0.2);
      }
    </style>

    <div id="title">
      [[filename]]
      <span id="remove">x</span>
    </div>

  </template>
  <script>
    class CodeEditor extends (Polymer.Element) {
      static get is() {
        return 'code-editor';
      }

      static get properties() {
        return {
          filename: {
            type: String,
            reflectToAttribute: true
          },
          mode: {
            type: String
          },
//          value: String,
          theme: {
            type: String,
            value: 'material'
          },
          editor: Object,
          MODES: {
            type: Object,
            readOnly: true,
            value: () => ({
              css: 'css',
              html: 'text/html',
              js: 'javascript',
              json: 'javascript'
            })
          }
        }
      }

//      static get observers() {
//        return [
//          'updateEditor(value)'
//        ]
//      }
//
      connectedCallback() {
        super.connectedCallback();
        this.editor = CodeMirror(this.shadowRoot, {
          value: this.value,
          mode: this.MODES[this.mode],
          htmlMode: this.mode === 'html',
          autoCloseTags: this.mode === 'html',
          autoCloseBrackets: true,
          theme: this.theme,
          tabSize: 2,
          lineNumbers: true,
          lineWrapping: true
        });
        this.editor.on('change', (e) => {
          this.$emit('file-edited', {filename: this.filename, value: e.getValue()});
        });
        this.shadowRoot.querySelector("#remove").addEventListener("click", this._removeFile.bind(this));
        window.addEventListener('resize', (e) => {
          this.$throttle(() => this._refreshEditor(), 1000/30);
        });
        setTimeout(() => {
          this._refreshEditor();
        }, 0);
      }

      _refreshEditor() {
        this.editor.refresh()
      }

      _updateEditor(value) {
//        if (this.editor)
//          this.editor.setValue(this.value);
        if (this.editor && value !== this.editor.getValue())
          console.log("we have a different text in editor and state!!");
      }

      _removeFile() {
        this.$emit('controller-remove-file', this.filename)
      }
      $emit(name, payload) {
        return this.dispatchEvent(new CustomEvent(name, {
          composed: true,
          bubbles: true,
          detail: payload,
        }));
      }

      $throttle(callback, ms) {
        this._throttleTimeout = this._throttleTimeout || null;
        if (!this._throttleTimeout)
          this._throttleTimeout = setTimeout(() => {
            this._throttleTimeout = null;
            callback();
          }, ms);
      }
    }

    customElements.define(CodeEditor.is, CodeEditor);
  </script>
</dom-module>