<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="app-router.html">
<link rel="import" href="app-state.html">
<link rel="import" href="app-pages.html">
<link rel="import" href="app-iconset.html">
<link rel="import" href="app-dialog.html">

<dom-module id="app-shell">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-state state="{{state}}"></app-state>
    <app-router default-url="home"></app-router>

    <app-pages page="[[state.session.route.segments.0]]">
      <home-page page="home"
                 user="[[state.persistent.user]]"
                 projects="[[_userProjects]]">
      </home-page>
      <editor-page page="editor"
                   current-project="[[state.persistent.currentProject]]"
                   versions="[[_currentVersions]]">
      </editor-page>
      <notfound-page page="notfound"></notfound-page>
    </app-pages>

    <app-dialog id="nickDialog" on-dialog-canceled="_signOut">
      <form on-submit="_submitNickname">
        <p>Enter your nickname to register</p>
        <input type="text" id="nickname" placeholder="nickname">
        <input type="submit" value="Finish">
      </form>
    </app-dialog>

  </template>
  <script>
    class AppShell extends IntertextMixin(Polymer.Element) {
      static get is() {
        return 'app-shell';
      }

      static get properties() {
        return {
          state: Object,
          _currentVersions: {
            type: Array,
            computed: "_retrieveVersions(state.persistent.currentProject, state.persistent.users)"
          },
          _userProjects: {
            type: Array,
            computed: "_retrieveUserProjects(state.persistent.user.name, state.persistent.users)"
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener('ui-nickname-dialog', (e) => this.$.nickDialog.open());
      }

      _retrieveVersions(currentProject, users) {
        if (!currentProject || !users)
          return [];
        let owner = currentProject.owner;
        let project = currentProject.project;
        if (!Tools.testPath(users, [owner, "projects", project, "versions"]))
          return [];
        return Object.keys(users[owner].projects[project].versions);
      }

      _retrieveUserProjects(username, users) {
        return !username || !users ? [] : users[username].projects;
      }

      _submitNickname(e) {
        e.preventDefault();
        this.$.nickDialog.close();
        this.$emit('controller-user-nickname', this.$.nickname.value);
        this.$.nickname.value = '';
      }

      _signOut(e) {
        this.$emit('controller-sign-out');
      }
    }

    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>