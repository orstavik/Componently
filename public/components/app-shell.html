<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="app-router.html">
<link rel="import" href="app-pages.html">
<link rel="import" href="app-iconset.html">
<link rel="import" href="app-dialog.html">

<dom-module id="app-shell">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <app-router default-url="home"></app-router>

    <app-pages page="[[state.session.route.segments.0]]">
      <home-page page="home"
                 user="[[state.persistent.user]]"
                 user-data="[[state._userObject]]">
      </home-page>
      <editor-page page="editor"
                   owner="[[state.session.route.segments.1]]"
                   project="[[state.session.route.segments.2]]"
                   version="[[state.session.actualVersion]]"
                   project-object="[[state._projectObjectWithWorkingCopy]]"
                   versions="[[state._projectObject.versions]]">
      </editor-page>
      <notfound-page page="notfound"></notfound-page>
    </app-pages>

    <app-dialog id="nickDialog" on-dialog-canceled="_signOut">
      <form on-submit="_submitNickname">
        <p>Enter your nickname to register</p>
        <input type="text" id="nickname" placeholder="nickname">
        <input type="submit" value="Finish">
      </form>
    </app-dialog>

  </template>
  <script>
    class AppShell extends IntertextMixin(Polymer.Element) {
      static get is() {
        return 'app-shell';
      }

      static get properties() {
        return {
          state: Object,
          history: Array,
        }
      }

      constructor() {
        super();

        this.state = new ObservableState(
          {
            session: {
              subscriptions: {}
            },
            persistent: {
              user: null
            }
          }
        );
        this.state.bindReducer('state-change-route', AppReducers._changeRoute);          //select-project

        //auth
        this.state.bindReducer('controller-auth-changed', UserReducers._authChanged);
        this.state.bindReducer('controller-sign-in', UserReducers._signIn);
        this.state.bindReducer('controller-sign-out', UserReducers._signOut);
        this.state.bindReducer('controller-user-nickname', UserReducers._userNickname);
        this.state.bindReducer('controller-new-user-data', UserReducers._newUserData);
        this.state.bindCompute("_userObject", UserReducers._makeUserObject, ["persistent.user.nickname", "persistent.users"]);
        this.state.bindObserve(UserReducers._userChanged, ["session.auth"]);

        this.state.bindReducer('controller-add-project', AppReducers._addProject);
        this.state.bindReducer('controller-remove-project', AppReducers._removeProject);
        this.state.bindReducer('controller-add-file', AppReducers._addFile);
        this.state.bindReducer('controller-remove-file', AppReducers._removeFile);
        this.state.bindReducer('controller-file-edited', AppReducers._fileEdited);
        //db
        this.state.bindReducer('controller-new-projects', AppReducers._newProjects);
        this.state.bindReducer('controller-new-versions', AppReducers._newVersions);
        this.state.bindReducer('controller-new-files', AppReducers._newFiles);
        this.state.bindReducer('controller-new-version-subscription', AppReducers._newVersionSubscription);
        this.state.bindReducer('controller-new-projects-subscription', AppReducers._newProjectsSubscription);

        this.state.bindCompute("_fullProjectObject", AppReducers._makeProjectObject, ["session.route.segments.1", "session.route.segments.2", "persistent.users"]);
        this.state.bindCompute("_editProjectObject", AppReducers._makeProjectObject, ["session.route.segments.1", "session.route.segments.2", "session.edits"]);
        this.state.bindCompute("_projectObjectWithWorkingCopy", AppReducers._mergedProjectObject, ["_fullProjectObject", "_editProjectObject"]);

        this.state.bindObserve(AppReducers._listenForFiles, ["session.route.segments", "session.actualVersion", "persistent"]);
        this.state.bindObserve(AppReducers._updateVersionsListener, ["session.route.segments"]);
        this.state.bindObserve(AppReducers._updateProjectsListener, ["persistent.user.nickname"]);
        this.state.bindObserve(AppReducers._projectsEdited, ["session.edits", "persistent.user.nickname"]);
        this.state.bindObserve(AppReducers._editsChanged, ["session.edits"]);

        firebase.auth().onAuthStateChanged((user) => Tools.emit('controller-auth-changed', user));
        window.addEventListener('ui-nickname-dialog', (e) => this.$.nickDialog.open());

        this.state.onChange(stateHist => {
          this.set("state", stateHist.state);
          this.set("history", stateHist.history);
        });

        window.addEventListener('controller-select-project', e => this._selectProject(e));
        window.addEventListener('controller-select-version', e => this._selectVersion(e));
      }

      _selectProject(e) {
        const id = e.detail;
        Tools.navigate(`/editor/${this.state.persistent.user.nickname}/${id}`);
      }
    
      _selectVersion(e) {
        const data = e.detail;
        Tools.navigate(`/editor/${data.owner}/${data.project}/${data.version}`);
      }

      _submitNickname(e) {
        e.preventDefault();
        this.$.nickDialog.close();
        Tools.emit('controller-user-nickname', this.$.nickname.value);
        this.$.nickname.value = '';
      }

      _signOut(e) {
        Tools.emit('controller-sign-out');
      }
    }

    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>